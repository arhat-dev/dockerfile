docker:buildkit:build:
- name: linux/base
  matrix@file: .dukkha/specs/matrix-linux.yml
  dockerfile@template: |-
    base/{{ .Env.MATRIX_LANGUAGE }}/{{ .Env.MATRIX_ROOTFS }}-{{ .Env.MATRIX_ARCH }}.dockerfile
  hooks:
    before@template: |-
      - shell: |-
          sh scripts/${MATRIX_LANGUAGE}/base-create-dockerfile.sh \
            {{ getDockerPlatformArch (.Env.MATRIX_ARCH | default "amd64") }}
        per_matrix_run: true
    after:success:
    - shell: rm "base/${MATRIX_LANGUAGE}/${MATRIX_ROOTFS}-${MATRIX_ARCH}.dockerfile"

  image_names@template: |-
    {{- $suffix := printf "%s:%s-%s" .Env.MATRIX_LANGUAGE .Env.MATRIX_ROOTFS .Env.MATRIX_ARCH -}}
    - image: docker.io/arhatdev/base-{{ $suffix }}
    - image: ghcr.io/arhat-dev/base-{{ $suffix }}

  extraArgs@template: |-
    {{- $platform_arch := getDockerPlatformArch .Env.MATRIX_ARCH -}}
    {{- if or (.Env.MATRIX_LANGUAGE | hasPrefix "go") (not (eq .Env.MATRIX_ARCH "mips64le" "armv5")) }}
    - --platform="linux/{{ $platform_arch }}"
    {{- end }}
    - --pull
    - --no-cache

docker:buildkit:push:
- name: linux/base
  matrix@file: .dukkha/specs/matrix-linux.yml
  image_names@template: |-
    {{- $suffix := printf "%s:%s-%s" .Env.MATRIX_LANGUAGE .Env.MATRIX_ROOTFS .Env.MATRIX_ARCH -}}
    - image: docker.io/arhatdev/base-{{ $suffix }}
    - image: ghcr.io/arhat-dev/base-{{ $suffix }}
