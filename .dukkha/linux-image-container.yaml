buildah:build:
- name: linux/container
  matrix@file: &matrix .dukkha/specs/matrix-linux.yml

  hooks:
    before:matrix@template:
    - shell: |-
        sh scripts/${MATRIX_LANGUAGE}/container-create-dockerfile.sh \
          {{ getDockerHubArch (.Env.MATRIX_ARCH | default "amd64") }}

    after:matrix:success:
    - shell: |-
        rm "container/${MATRIX_LANGUAGE}/${MATRIX_ROOTFS}-${MATRIX_ARCH}.dockerfile"

    after:matrix:failure:
    - shell: |-
        cat "container/${MATRIX_LANGUAGE}/${MATRIX_ROOTFS}-${MATRIX_ARCH}.dockerfile"

  file@env: |-
    container/${MATRIX_LANGUAGE}/${MATRIX_ROOTFS}-${MATRIX_ARCH}.dockerfile

  image_names@env: &image_names
  - image: ${IMAGE_REPO}/${MATRIX_LANGUAGE}:${MATRIX_ROOTFS}-${MATRIX_ARCH}
    manifest: ${IMAGE_REPO}/${MATRIX_LANGUAGE}:${MATRIX_ROOTFS}

  extra_args:
  - --pull-always

buildah:push:
- name: linux/container
  hooks:
    before:
    - task: buildah:login(ghcr)
  matrix@file: *matrix
  image_names@env: *image_names
