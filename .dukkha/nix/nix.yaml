buildah:bud:
- name: nix
  env: &env
  # source: https://github.com/NixOS/nix.git
  - VERSION=2.3.14
  - IMAGE_NAME=ghcr.io/arhat-dev/nix
  matrix: &matrix
    kernel:
    - linux
    rootfs:
    - alpine
    - debian
    arch:
    - amd64
    - arm64
    - x86
  dockerfile@env: nix/Dockerfile
  image_names@file|env|template: &image_names |-
    .dukkha/templates/app-image-env-version-image-name.yml
  extra_args@file|env|template: |-
    .dukkha/templates/app-image-env-version-extra-args.yml

buildah:push:
- name: nix
  env: *env
  matrix: *matrix
  hooks:
    before:
    - task: buildah:login(ghcr)
  image_names@file|env|template: *image_names
