buildah:bud:
- name: linux/builder
  matrix@file: .dukkha/specs/matrix-linux.yml

  hooks:
    before:matrix@template:
    - shell: |-
        sh scripts/${MATRIX_LANGUAGE}/builder-create-dockerfile.sh \
          {{ getDockerHubArch (.Env.MATRIX_ARCH | default "amd64") }}

    after:matrix:success:
    - shell: |-
        rm "builder/${MATRIX_LANGUAGE}/${MATRIX_ROOTFS}-${MATRIX_ARCH}.dockerfile"
    after:matrix:failure:
    - shell: |-
        cat "builder/${MATRIX_LANGUAGE}/${MATRIX_ROOTFS}-${MATRIX_ARCH}.dockerfile"

  dockerfile@env: |-
    builder/${MATRIX_LANGUAGE}/${MATRIX_ROOTFS}-${MATRIX_ARCH}.dockerfile

  image_names@template: &builder_image_names |-
    {{- $suffix := printf "%s:%s-%s" .Env.MATRIX_LANGUAGE .Env.MATRIX_ROOTFS .Env.MATRIX_ARCH -}}
    {{- $manifest_suffix := printf "%s:%s" .Env.MATRIX_LANGUAGE .Env.MATRIX_ROOTFS -}}
    - image: ghcr.io/arhat-dev/builder-{{ $suffix }}
      manifest: ghcr.io/arhat-dev/builder-{{ $manifest_suffix }}

  extra_args:
  - --pull=false
  - --pull-never

buildah:push:
- name: linux/builder
  hooks:
    before:
    - task: buildah:login:ghcr
  matrix@file: .dukkha/specs/matrix-linux.yml
  image_names@template: *builder_image_names
