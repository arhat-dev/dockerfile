buildah:bud:
- name: linux/builder-prepare
  matrix@file: &matrix .dukkha/specs/matrix-linux.yml
  dockerfile@env: |-
    builder/${MATRIX_LANGUAGE}/${MATRIX_ROOTFS}-${MATRIX_ARCH}.dockerfile
  image_names@env:
  - image: prepare-${MATRIX_LANGUAGE}:${MATRIX_ROOTFS}-${MATRIX_ARCH}
  extra_args@env:
  - --target=dukkha
  - --pull-always
  - --build-arg="DUKKHA_IMAGE=ghcr.io/arhat-dev/dukkha:latest-${MATRIX_ARCH}"
  - --build-arg="BASE_IMAGE=scratch"

- name: linux/builder
  matrix@file: *matrix
  hooks:
    before:matrix@template:
    - shell: |-
        sh scripts/${MATRIX_LANGUAGE}/builder-create-dockerfile.sh \
          {{ getDockerHubArch (.Env.MATRIX_ARCH | default "amd64") }}
    - task: buildah:bud:linux/builder-prepare

    after:matrix:success:
    - shell: |-
        rm "builder/${MATRIX_LANGUAGE}/${MATRIX_ROOTFS}-${MATRIX_ARCH}.dockerfile"
    after:matrix:failure:
    - shell: |-
        cat "builder/${MATRIX_LANGUAGE}/${MATRIX_ROOTFS}-${MATRIX_ARCH}.dockerfile"

  dockerfile@env: |-
    builder/${MATRIX_LANGUAGE}/${MATRIX_ROOTFS}-${MATRIX_ARCH}.dockerfile

  image_names@env: &image_names
  - image: ghcr.io/arhat-dev/builder-${MATRIX_LANGUAGE}:${MATRIX_ROOTFS}-${MATRIX_ARCH}
    manifest: ghcr.io/arhat-dev/builder-${MATRIX_LANGUAGE}:${MATRIX_ROOTFS}

  extra_args@template: |-
    {{- $base_image_name := printf "ghcr.io/arhat-dev/base-%s:%s-%s" .Env.MATRIX_LANGUAGE .Env.MATRIX_ROOTFS .Env.MATRIX_ARCH -}}
    {{- $base_image_id := os_ReadFile (getBuildahImageIDFile $base_image_name) -}}

    {{- $dukkha_image_name := printf "prepare-%s:%s-%s" .Env.MATRIX_LANGUAGE .Env.MATRIX_ROOTFS .Env.MATRIX_ARCH -}}
    {{- $dukkha_image_id := os_ReadFile (getBuildahImageIDFile $dukkha_image_name) -}}

    - --pull-never
    - --build-arg="DUKKHA_IMAGE={{ $dukkha_image_id }}"
    - --build-arg="BASE_IMAGE={{ $base_image_id }}"

buildah:push:
- name: linux/builder
  hooks:
    before:
    - task: buildah:login:ghcr
  matrix@file: *matrix
  image_names@env: *image_names
