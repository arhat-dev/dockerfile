docker:build:
- &linux_builder_build
  name: linux/builder
  matrix@file: .dukkha/specs/matrix-linux.yml

  hooks:
    before@template: |-
      - shell: |-
          sh scripts/${MATRIX_LANGUAGE}/builder-create-dockerfile.sh \
            {{ getDockerHubArch (.Env.MATRIX_ARCH | default "amd64") }}
        per_matrix_run: true

    after:success:
    - shell: |-
        rm "builder/${MATRIX_LANGUAGE}/${MATRIX_ROOTFS}-${MATRIX_ARCH}.dockerfile"

  dockerfile@template: |-
    builder/{{ .Env.MATRIX_LANGUAGE }}/{{ .Env.MATRIX_ROOTFS }}-{{ .Env.MATRIX_ARCH }}.dockerfile

  image_names@template: |-
    {{- $suffix := printf "%s:%s-%s" .Env.MATRIX_LANGUAGE .Env.MATRIX_ROOTFS .Env.MATRIX_ARCH -}}
    {{- $manifest_suffix := printf "%s:%s" .Env.MATRIX_LANGUAGE .Env.MATRIX_ROOTFS -}}
    # - image: docker.io/arhatdev/builder-{{ $suffix }}
    #   manifest: docker.io/arhatdev/builder-{{ $manifest_suffix }}
    - image: ghcr.io/arhat-dev/builder-{{ $suffix }}
      manifest: ghcr.io/arhat-dev/builder-{{ $manifest_suffix }}

docker:push:
- &linux_builder_push
  name: linux/builder
  matrix@file: .dukkha/specs/matrix-linux.yml
  image_names@template: |-
    {{- $suffix := printf "%s:%s-%s" .Env.MATRIX_LANGUAGE .Env.MATRIX_ROOTFS .Env.MATRIX_ARCH -}}
    {{- $manifest_suffix := printf "%s:%s" .Env.MATRIX_LANGUAGE .Env.MATRIX_ROOTFS -}}
    - image: docker.io/arhatdev/builder-{{ $suffix }}
      manifest: docker.io/arhatdev/builder-{{ $manifest_suffix }}
    - image: ghcr.io/arhat-dev/builder-{{ $suffix }}
      manifest: ghcr.io/arhat-dev/builder-{{ $manifest_suffix }}

buildah:bud:
- *linux_builder_build

buildah:push:
- *linux_builder_push

buildah:in-docker:bud:
- *linux_builder_build

buildah:in-docker:push:
- *linux_builder_push
