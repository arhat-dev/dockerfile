buildah:bud:
- name: spilo-base
  matrix: &matrix
    kernel:
    - linux
    arch:
    - amd64
  hooks:
    before:
    - shell: |-
        [ -d build/spilo ] && exit 0

        git clone --branch 2.0-p7 \
          https://github.com/zalando/spilo.git \
          build/spilo
  dockerfile: build/spilo/postgres-appliance/Dockerfile
  context: build/spilo/postgres-appliance
  image_names@env:
  - image: spilo-base:${MATRIX_ARCH}

  extra_args@env:
  - --build-arg
  # source: https://github.com/timescale/timescaledb
  - TIMESCALEDB=2.3.0
  - --build-arg
  - BASE_IMAGE=registry.opensource.zalan.do/library/ubuntu-18.04
  - --build-arg
  - PGVERSION=13
  - --build-arg
  - PGOLDVERSIONS='9.6 10 11 12'
  - --build-arg
  - DEMO=false
  - --build-arg
  - TIMESCALEDB_APACHE_ONLY=false
  # required, or buildah bud will fail due to unable to find
  # image resulted from `builder-false` stage
  - --layers=true

- name: spilo
  env:
  - IMAGE_NAME=ghcr.io/arhat-dev/spilo
  matrix: *matrix
  hooks:
    before:matrix:
    - task: buildah:bud(spilo-base)
  dockerfile: app/spilo.dockerfile
  image_names@env: &image_names
  - image: ${IMAGE_NAME}:latest-${MATRIX_ARCH}
    manifest: ${IMAGE_NAME}:latest-${MATRIX_ARCH}
  - image: ${IMAGE_NAME}:$(git -C build/spilo describe --tags)-${MATRIX_ARCH}
    manifest: ${IMAGE_NAME}:$(git -C build/spilo describe --tags)

  extra_args@template: |-
    {{- $base_image_name := printf "spilo-base:%s" .Env.MATRIX_ARCH -}}
    {{- $base_image_id := os_ReadFile (getBuildahImageIDFile $base_image_name) -}}
    - --pull-never
    - --build-arg
    - BASE_IMAGE={{ $base_image_id }}

buildah:push:
- name: spilo
  hooks:
    before:
    - task: buildah:login(ghcr)
  matrix: *matrix
  image_names@env: *image_names
