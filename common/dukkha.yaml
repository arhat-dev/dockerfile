buildah:build:
################################
#
# Base
#
################################

- name: linux/base
  env:
  - IMAGE_NAME_PREFIX=base-
  matrix@file: &matrix common/matrix-base.yml
  file@template: |-
    {{- if and (ne .Env.MATRIX_CROSS_ARCH "") (ne .Env.MATRIX_ARCH .Env.MATRIX_CROSS_ARCH) -}}
    common/base-cross.dockerfile
    {{- else -}}
    common/base.dockerfile
    {{- end -}}

  image_names@file|template|env: &base_image_names common/templates/image-names.yml

  extra_args@template: |-
    {{- $host_arch := "" -}}
    {{- $cross_arch := "" -}}
    {{- $triple_name := "" -}}
    {{- if eq .Env.MATRIX_ROOTFS "debian" -}}
      {{- $host_arch = getDebianArch .Env.MATRIX_ARCH -}}
      {{- $cross_arch = getDebianArch .Env.MATRIX_CROSS_ARCH -}}
      {{- $triple_name = getDebianTripleName .Env.MATRIX_CROSS_ARCH -}}
    {{- else if eq .Env.MATRIX_ROOTFS "alpine" -}}
      {{- $host_arch = getAlpineArch .Env.MATRIX_ARCH -}}
      {{- $cross_arch = getAlpineArch .Env.MATRIX_CROSS_ARCH -}}
      {{- $triple_name = getAlpineTripleName .Env.MATRIX_CROSS_ARCH -}}
    {{- end -}}

    {{- $rootfs_with_version := "" -}}
    {{- if eq .Env.MATRIX_ROOTFS "debian" -}}
      {{- $rootfs_with_version = .Env.DEBIAN_VERSION -}}
    {{- else if eq .Env.MATRIX_ROOTFS "alpine" -}}
      {{- $rootfs_with_version = printf "alpine%s" .Env.ALPINE_VERSION -}}
    {{- end -}}

    {{- $base_image := "" -}}
    {{- if eq .Env.MATRIX_LANGUAGE "golang" "python" "rust" "ruby" -}}
      {{- $base_image = printf "docker.io/%s/%s:%s-%s" (getDockerHubArch .Env.MATRIX_ARCH) .Env.MATRIX_LANGUAGE .Env.MATRIX_VERSION $rootfs_with_version -}}
    {{- else if eq .Env.MATRIX_LANGUAGE "nodejs" -}}
      {{- $base_image = printf "docker.io/%s/node:%s-%s" (getDockerHubArch .Env.MATRIX_ARCH) .Env.MATRIX_VERSION $rootfs_with_version -}}
    {{- else if eq .Env.MATRIX_LANGUAGE "java" -}}
      {{- $repo_name := printf "openjdk%s" .Env.MATRIX_VERSION -}}
      {{- if eq .Env.MATRIX_ARCH "amd64" "s390x" "ppc64le" -}}
        {{- $repo_name = printf "%s-openj9" $repo_name -}}
      {{- end -}}

      {{- $tag_name := "" -}}
      {{- if eq .Env.MATRIX_ROOTFS "debian" -}}
        {{- $tag_name = "debianslim-slim" -}}
      {{- else if eq .Env.MATRIX_ROOTFS "alpine" -}}
        {{- $tag_name = "alpine-slim" -}}
      {{- end -}}

      {{- $base_image = printf "docker.io/adoptopenjdk/%s:%s" $repo_name $tag_name -}}
    {{- end -}}
    {{ if eq .Env.MATRIX_LANGUAGE "java" }}
    # adoptopenjdk sets os/arch/variant
    - --os={{ .Env.MATRIX_KERNEL | getOciOS }}
    - --arch={{ .Env.MATRIX_ARCH | getOciArch }}
    - --variant={{ .Env.MATRIX_ARCH | getOciArchVariant }}
    {{ end }}
    - --pull-always
    - --no-cache
    - --build-arg
    - BASE_IMAGE={{ $base_image }}
    # - --build-arg
    # - QEMU_ARCH={{ getQemuArch .Env.MATRIX_ARCH }}
    # - --build-arg
    # - QEMU_VERSION={{ .Env.QEMU_VERSION }}
    - --build-arg
    - PROGRAMMING_LANGUAGE={{ .Env.MATRIX_LANGUAGE }}
    - --build-arg
    - MATRIX_ROOTFS={{ .Env.MATRIX_ROOTFS }}
    - --build-arg
    - HOST_ARCH={{ $host_arch }}
    - --build-arg
    - CROSS_ARCH={{ $cross_arch }}
    - --build-arg
    - CROSS_TRIPLE_NAME={{ $triple_name }}
    - --build-arg
    - MATRIX_ARCH={{ .Env.MATRIX_ARCH }}
    - --build-arg
    - MATRIX_CROSS_ARCH={{ .Env.MATRIX_CROSS_ARCH }}
    # for java
    - --build-arg
    - MAVEN3_VERSION={{ .Env.MAVEN3_VERSION }}

################################
#
# Builder
#
################################

- name: linux/builder-prepare-dukkha
  matrix@file: *matrix
  file: common/builder.dockerfile
  image_names@env:
  - image: local-dukkha:${MATRIX_ARCH}
  extra_args@env:
  - --target=dukkha
  - --pull-always
  - --build-arg
  - DUKKHA_IMAGE=ghcr.io/arhat-dev/dukkha:latest-${MATRIX_ARCH}
  - --build-arg
  - BASE_IMAGE=scratch
  - --build-arg
  - PROGRAMMING_LANGUAGE={{ .Env.MATRIX_LANGUAGE }}

- name: linux/builder
  env:
  - IMAGE_NAME_PREFIX=builder-
  matrix@file: *matrix
  hooks:
    before:matrix:
    - task: buildah:build(linux/builder-prepare-dukkha)
  file: common/builder.dockerfile
  image_names@file|template|env: &builder_image_names common/templates/image-names.yml

  extra_args@template: |-
    {{- $prefix := printf "%s/base-%s" .Env.IMAGE_REPO .Env.MATRIX_LANGUAGE -}}
    {{- $tag := printf "%s-%s" .Env.MATRIX_ROOTFS .Env.MATRIX_ARCH -}}
    {{- if and (ne .Env.MATRIX_CROSS_ARCH "") (ne .Env.MATRIX_ARCH .Env.MATRIX_CROSS_ARCH) -}}
      {{- $tag = printf "%s-%s-%s" .Env.MATRIX_ROOTFS .Env.MATRIX_ARCH .Env.MATRIX_CROSS_ARCH -}}
    {{- end -}}

    {{- $base_image_name := printf "%s:%s-%s" $prefix .Env.MATRIX_VERSION $tag -}}
    {{- $base_image_id := os_ReadFile (getBuildahImageIDFile $base_image_name) -}}

    {{- $dukkha_image_name := printf "local-dukkha:%s" .Env.MATRIX_ARCH -}}
    {{- $dukkha_image_id := os_ReadFile (getBuildahImageIDFile $dukkha_image_name) -}}

    - --pull-never
    - --build-arg
    - DUKKHA_IMAGE={{ $dukkha_image_id }}
    - --build-arg
    - BASE_IMAGE={{ $base_image_id }}
    - --build-arg
    - PROGRAMMING_LANGUAGE={{ .Env.MATRIX_LANGUAGE }}

################################
#
# Container
#
################################
- name: linux/container
  env:
  - IMAGE_NAME_PREFIX=
  matrix@file: common/matrix-container.yml
  hooks:
    before:
    - shell: |-
        cat <<EOF >common/matrix-container.yml
        #
        # NOTE: this file is generate by common/dukkha.yaml
        #
        # exclude cross_arch builds since we only want target runtime
        exclude:
        - arch:
          - amd64
          - arm64
          cross_arch:
          - armv7
          - armv6
          - armv5
          - ppc64le
          - s390x
          - x86
          - mips64le
        - arch:
          - arm64
          cross_arch:
          - amd64
        - arch:
          - amd64
          cross_arch:
          - arm64
        EOF

        cat common/matrix-base.yml >>common/matrix-container.yml

  file@env: common/container.dockerfile
  image_names@env: &image_names
  - image: ${IMAGE_REPO}/${MATRIX_LANGUAGE}:${MATRIX_ROOTFS}-${MATRIX_ARCH}
    manifest: ${IMAGE_REPO}/${MATRIX_LANGUAGE}:${MATRIX_ROOTFS}

  extra_args:
  - --pull-always

buildah:push:
- name: linux/base
  hooks:
    before:
    - task: buildah:login(ghcr)
  matrix@file: *matrix
  image_names@file|template: *base_image_names

- name: linux/builder
  hooks:
    before:
    - task: buildah:login(ghcr)
  matrix@file: *matrix
  image_names@file|template: *builder_image_names
