bootstrap:
  env:
  - DEBIAN_VERSION=buster
  - ALPINE_VERSION=3.13
  # source: https://github.com/golang/go
  - GO_VERSION=1.16
  # source: https://github.com/rust-lang/rust
  - RUST_VERSION=1.53
  # source: https://github.com/multiarch/qemu-user-static
  - QEMU_VERSION=5.2.0-2
  # TODO: set source for ruby so renovate can work
  - RUBY_VERSION=2.7
  - IMAGE_REPO=ghcr.io/arhat-dev

tools:
  buildah:
  - name: local
    cmd: [buildah]
  - name: in-docker
    # create a docker volume for buildah
    #
    # $ docker volume create buildah-dockerfile
    cmd@env:
    - docker
    - run
    - -it
    - --rm
    - --workdir
    - $(pwd)
    - -v
    - $(pwd):$(pwd)
    - --security-opt
    - label=disable
    - --security-opt
    - seccomp=unconfined
    - -v
    - buildah-dockerfile:/var/lib/containers
    - --device
    - /dev/fuse:rw
    - quay.io/buildah/stable
    - buildah

  golang:
  - name: local
  workflow:
  - name: local
  - name: in-docker
  docker:
  - name: local

shells:
- name: sh
  cmd: [sh]

buildah:login:
- &ghcr_login
  name: ghcr
  registry: ghcr.io
  username: ${GHCR_USER}
  password@env: ${GHCR_PASS}

docker:login:
- *ghcr_login

workflow:run:
- name: build-common-images
  matrix: &kind_matrix
    kernel:
    - linux
    target:
    - base
    - builder
    - container
    language:
    - go
    - python3.6
    - python3.7
    - python3.8
    - python3.9
    - rust
  hooks:
    after:
    - shell: buildah images
  jobs:
  - task@env: |-
      buildah:bud(
        ${MATRIX_KERNEL}/${MATRIX_TARGET},
        { language: [${MATRIX_LANGUAGE}] }
      )
  - task@env: |-
      buildah:push(
        ${MATRIX_KERNEL}/${MATRIX_TARGET},
        { language: [${MATRIX_LANGUAGE}] }
      )
