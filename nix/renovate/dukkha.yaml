buildah:build:
- name: renovate-slim
  env: &slim_env
  - APP=renovate-slim
  # source: https://github.com/renovatebot/renovate.git
  - &version VERSION=25.53.3
  - &default_rootfs DEFAULT_ROOTFS=alpine
  matrix: &matrix
    kernel:
    - linux
    rootfs:
    - alpine
    arch:
    - arm64
    # - amd64
    # - x86
  file@env: nix/renovate/slim.dockerfile
  image_names@template|file|env|template: &image_names |-
    templates/image-names/include-rootfs-info/
    {{- /* multi-line join */ -}}
    env[APP:VERSION:DEFAULT_ROOTFS].yml
  extra_args@file|env|template: templates/image-extra-args/env[VERSION].yml

- name: renovate
  env: &full_env
  - APP=renovate
  - *version
  - *default_rootfs
  matrix: *matrix
  hooks:
    before:matrix:
    - task: buildah:build(renovate-slim)

  file: app/renovate/full.dockerfile
  image_names@template|file|env|template: *image_names
  extra_args@template: |-
    {{- $slim_image_name := printf  "ghcr.io/arhat-dev/renovate-slim:%s-%s-$s" .Env.VERSION .Env.MATRIX_ROOTFS .Env.MATRIX_ARCH -}}
    {{- $slim_image_id := os_ReadFile (getBuildahImageIDFile $slim_image_name) -}}
    - --pull-never
    - --build-arg
    - SLIM_IMAGE={{ $slim_image_id }}

buildah:push:
- name: renovate-slim
  env: *slim_env
  matrix: *matrix
  hooks: &push_hooks
    before:
    - task: buildah:login(ghcr)
  image_names@template|file|env|template: *image_names

- name: renovate
  env: *full_env
  matrix: *matrix
  hooks: *push_hooks
  image_names@template|file|env|template: *image_names
